<table id="stage_<%= stage.id %>" class="data-table table table-hover">
  <thead>
    <th width="15%">Home</th>
    <th width="15%" no-sort no-filter>GH</th>
    <th width="5%" no-sort no-filter> - </th>
    <th width="15%" no-sort no-filter>GA</th>
    <th width="15%">Away</th>
    <th width="20%">Date Played</th>
    <th width="15%" no-sort no-filter><!-- Actions --></th>
  </thead>
  <tbody>
    <% stage.fixtures.with_game.each do |fixture| %>
      <tr data-id=<%= fixture.id %>>
        <td><%= fixture.home %></td>
        <td><%= text_field_tag :home_score, fixture.home_score, class: 'form-control full-score', disabled: fixture.user_team_playing %></td>
        <td> - </td>
        <td><%= text_field_tag :away_score, fixture.away_score, class: 'form-control full-score', disabled: fixture.user_team_playing %></td>
        <td><%= fixture.away %></td>
        <td>
          <%= text_field_tag :date_played, time_to_string(fixture.date_played, '%B %e, %Y'), class: "form-control #{'datepicker' unless fixture.user_team_playing}", disabled: true %>
        </td>
        <td>
          <% if fixture.user_team_playing %>
            <!-- Link to new Game or existing Game -->
            <%= fixture.game_exists ?
              link_to('View Game', fixture.game, class: 'button button-small button-block button-raised button-primary', target: '_blank') :
              link_to('Play Game', new_game_path(fixture: fixture.id), class: 'button button-small button-block button-raised button-action', target: '_blank') %>
          <% else %>
            <button class="update-btn button button-small button-block button-raised button-highlight" disabled>Update</button>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<script>
  $(function(){
    $('table#stage_<%= stage.id %>').on('input', 'input', function(){
      var tr = $(this).closest('tr');
      var empty = false;
      $('input', tr).each(function(){
        if (!$(this).val())
          empty = true;
      })

      $('.update-btn', tr).prop('disabled', empty);
    });

    $('table#stage_<%= stage.id %>').on('click', '.update-btn', function(){
      var tr = $(this).closest('tr');
      var id = tr.data('id');
      if (id && !$(this).prop('disabled'))
        $.ajax({
          url: '/cmsk/fixtures/'+id,
          type: 'PUT',
          data: { 
            fixture: {
              home_score: $('#home_score', tr).val(),
              away_score: $('#away_score', tr).val(),
              date_played: $('#date_played', tr).val()
            }
          }
        })
    })
  })
</script>