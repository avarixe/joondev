<script>
  var num_subs = <%= @fixture.player_records.length - 11 %>;
  var highest_rating;

  $(function(){
    // Flatpickr functionality
    $('#fixture_date_played').flatpickr({ altInput: true });
    
    // Click fields functionality
    $('.click-form').each(function(){ toggleClickForm($(this)); });
      
    $('html').on('click', 'a[data-action="add-sub"]', function(){ addRecord(this); });
    $('html').on('click', 'a[data-action="remove"]',  function(){ removeRecord(this); });



    // $('#remove-sub-btn').click(function(){
    //   if (num_subs > 0){
    //     $('#records-table tbody tr:last').remove();
    //     num_subs--;
    //   }
    // });
      
    // By default, highest rating gets MOTM
    highest_rating = $('input.rating').map(function(){
      return this.value;
    }).get().sort().pop();
    $('table').on('input', '.rating', function(){
      if (this.value > highest_rating){
        highest_rating = this.value;
        setMOTM($('.ui.ribbon.pos', $(this).closest('tr')));
      }
    });
  
    // Clicking a ribbon label sets MOTM
    $('table').on('click', '.ui.ribbon.pos', function(){ setMOTM(this); });
  
    // Selecting a Player loads OVR
    $('table').on('change', '.player_id', function(){
      var this_ = $(this);
      if (this_.val())
        $.get("/my_fifa/players/"+$('select', this_).val()+"/get_ovr", function(data){
          $('.ovr', this_.closest('tr')).val(data);
        });
    });
  
    // Squad auto populates players and positions
    $('select[id$="squad_id"]').change(function(){
      if ($(this).val()){
        $.get("/my_fifa/squads/"+$(this).val()+"/info", function(data){
          $.each(data.player_ids, function(i, player_id){
            var tr = $('#fixture_player_records_attributes_'+i+'_pos').closest('tr');
            $('select[id$="player_id"]', tr).dropdown('set selected', player_id);

            // Update Position labels
            $('td:first-child input', tr).val(data.positions[i]);
            $('td:first-child .ribbon', tr).text(data.positions[i]);
          });
        });
        $('#update-squad-btn').attr('disabled', false);
      } else
        $('#update-squad-btn').attr('disabled', true);
    });
  
    $('#update-squad-btn').click(function(evt){
      evt.preventDefault();
  
      var squadId = $('#squad').val();
      var rows = $('#records-table tbody tr');
      var squadParams = {};
      for(var i=0; i < 11; i++)
        squadParams['player_id_'+(i+1)] = $('.player_id', $(rows[i])).val();
  
      $.ajax({
        url: '/my_fifa/squads/'+squadId,
        type: 'PUT',
        beforeSend: function(xhr){ xhr.setRequestHeader('X-CSRF-Token', '<%= form_authenticity_token %>')},
        data: { squad: squadParams },
        statusCode: {
          500: function(){ swal('Error', 'Attempt to update the Squad failed.', 'error'); }
        }
      }).then(function(){
        swal('Success', 'Squad has been updated to the current lineup.', 'success');
      });
    });
  });
  
  function toggleClickForm(target){
    $(target).click(function(){
      var value = parseInt($(target).val(), 10);
      $(this).val(isNaN(value) ? 1 : value+1);
    });
    $(target).contextmenu(function(event){
      event.preventDefault();
      var value = parseInt($(target).val(), 10);
      $(this).val((isNaN(value) || value == 1 || value == 0) ? null : value-1);
    });
  }
  
  function addRecord(target){
    // Generate new Record table row
    var record = $('<tr/>');

    // Parent is a Substitute
    var id = moment().valueOf();
    console.log($('input[id$="pos"]', $(target).closest('tr')).attr('id'))
    console.log($('input[id$="pos"]', $(target).closest('tr')).attr('id').indexOf('sub_record'))
    if ($('input[id$="pos"]', $(target).closest('tr')).attr('id').indexOf('sub_record') > 0){
      record.append($(target).closest('tr').html()
        .replace(/(\[sub_record_attributes\])/g, '$1[sub_record_attributes]')
        .replace(/(_sub_record_attributes)/g, '$1_sub_record_attributes'));
    } else { // Parent is not a Substitute
      record.append($(target).closest('tr').html()
        .replace(/(\[player_records_attributes\])\[(\d+)\]/g, '$1[$2][sub_record_attributes]')
        .replace(/(_player_records_attributes)_(\d+)/g, '$1_$2_sub_record_attributes'));

      // Set Substitute behavior
      $(record)
        .find('a[data-action="no remove"]')
        .attr('data-action', "remove")
    }

    // Remove Error classes
    $('.error', record).removeClass('error');

    // Copy POS
    var pos = $(target).closest('tr').find('.pos');
    $('.pos > span', record).text(pos.text())
    $('.pos .level.icon', record).last().css('visibility', 'hidden');
    $('.pos', record)
      .append('<i class="level up green icon"></i>')
      .prev()
        .val(pos.prev().val());
    $('input[type != "hidden"]', record).val('');


    // Add indicators original Player has been SUBBED
    $('.pos', $(target).closest('tr'))
      .append('<i class="level down red icon"></i>');
    $(target).closest('.item')
      .addClass('disabled')
      .siblings('[data-action="remove"]').addClass('disabled');
    // Append new row to table
    $(target).closest('tr').after(record);
  
    // Activate jQuery event listeners
    $('.click-form', record).each(function(){
      toggleClickForm($(this));
    });

    // Substitute actions menu was copied weirdly. Hack fix
    $('.teal.dropdown > .fluid.menu')
      .removeClass('transition visible animating slide down out')
      .attr('style', '');
    $('.ui.dropdown', record).dropdown().dropdown('clear');

  }

  function removeRecord(target){
    var tr = $(target).closest('tr');
    var parentTr = tr.prev();

    if (tr.data('id')){
      $('input[id$="_destroy"]', tr).val(1);
      $(tr).css('display', 'none !important');
    }
    else
      tr.remove();

    $('.ribbon .level.icon', parentTr).last().remove();
    $('a[data-action="add-sub"]', parentTr).removeClass('disabled');
    $('a[data-action="remove"]', parentTr).removeClass('disabled');
  }
  
  function setMOTM(target){
    var playerId = $('.player_id', $(target).closest('tr')).dropdown('get value');
    if (playerId){
      $('#fixture_motm_id').val(playerId);
      $('.ui.ribbon.pos').removeClass('yellow');
      $(target).addClass('yellow');        
    }
  }
</script>