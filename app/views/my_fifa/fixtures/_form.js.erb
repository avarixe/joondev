var num_subs = <%= @fixture.player_records.length - 11 %>;
var highest_rating;

$(function(){
  // Flatpickr functionality
  $('#fixture_date_played').flatpickr({ altInput: true });
  
  // Click fields functionality
  $('.click-form').each(function(){ toggleClickForm($(this)); });
    
  // +/- SUB button functionality
  $('#add-sub-btn').click(function(){ addRecord(); });
  $('#remove-sub-btn').click(function(){
    if (num_subs > 0){
      $('#records-table tbody tr:last').remove();
      num_subs--;
    }
  });
    
  // By default, highest rating gets MOTM
  highest_rating = $('input.rating').map(function(){
    return this.value;
  }).get().sort().pop();
  $('table').on('input', '.rating', function(){
    if (this.value > highest_rating){
      highest_rating = this.value;
      setMOTM($('.ui.ribbon.pos', $(this).closest('tr')));
    }
  });

  // Clicking a ribbon label sets MOTM
  $('table').on('click', '.ui.ribbon.pos', function(){ setMOTM(this); });

  // Selecting a Player loads OVR
  $('table').on('change', '.player_id', function(){
    var this_ = this;
    $.get("/my_fifa/players/"+$('select', $(this_)).val()+"/get_ovr", function(data){
      $('.ovr', $(this_).closest('tr')).val(data);
    });
  });

  // Squad auto populates players
  $('#squad').change(function(){
    if ($('#squad').val()){
      $.get("/my_fifa/squads/"+$('#squad').val()+"/players_json", function(data){
        $.each(data.players, function(i, player){
          var tr = $('#fixture_player_records_attributes_'+i+'_pos').closest('tr');
          $('select[id$="player_id"]', tr).dropdown('set selected', player.id);
          // $('.ovr', tr).val(player.current_ovr);
        });
      });
      $('#update-squad-btn').attr('disabled', false);
    } else
      $('#update-squad-btn').attr('disabled', true);
  });

  $('#update-squad-btn').click(function(evt){
    evt.preventDefault();

    var squadId = $('#squad').val();
    var rows = $('#records-table tbody tr');
    var squadParams = {};
    for(var i=0; i < 11; i++)
      squadParams['player_id_'+(i+1)] = $('.player_id', $(rows[i])).val();

    $.ajax({
      url: '/my_fifa/squads/'+squadId,
      type: 'PUT',
      beforeSend: function(xhr){ xhr.setRequestHeader('X-CSRF-Token', '<%= form_authenticity_token %>')},
      data: { squad: squadParams },
      statusCode: {
        500: function(){ swal('Error', 'Attempt to update the Squad failed.', 'error'); }
      }
    }).then(function(){
      swal('Success', 'Squad has been updated to the current lineup.', 'success');
    });
  });
});

function toggleClickForm(target){
  $(target).click(function(){
    var value = parseInt($(target).val(), 10);
    $(this).val(isNaN(value) ? 1 : value+1);
  });
  $(target).contextmenu(function(event){
    event.preventDefault();
    var value = parseInt($(target).val(), 10);
    $(this).val((isNaN(value) || value == 1 || value == 0) ? null : value-1);
  });
}

function addRecord(){
  var id = moment().valueOf();

  // Generate new Record table row
  var record = $('<tr/>');
  record.append($('#record-template').html()
    .replace(/fixture\[player\_records\_attributes\]\[\d+\]/g, 'fixture[player_records_attributes]['+id+']')
    .replace(/fixture\_player\_records\_attributes\_\d+/g, 'fixture_player_records_attributes_'+id));
  $('.pos', record).text('SUB '+(++num_subs));
  $('.pos', record).prev().val('SUB '+(num_subs));

  // Append new row to table
  $('#records-table tbody').append(record);

  // Activate jQuery event listeners
  $('.click-form', $(record)).each(function(){
    toggleClickForm($(this));
  });
}  

function setMOTM(target){
  var playerId = $('.player_id', $(target).closest('tr')).dropdown('get value');
  if (playerId){
    $('#fixture_motm_id').val(playerId);
    $('.ui.ribbon.pos').removeClass('yellow');
    $(target).addClass('yellow');        
  }
}